---
import { getCollection } from 'astro:content';

const courses = (await getCollection('courses')).sort((a, b) => a.data.order - b.data.order);

const categoryMeta: Record<string, { label: string; icon: string; banner: string }> = {
    'circus-kindertanz': {
        label: 'Circus & Kindertanz',
        icon: 'fas fa-hat-wizard',
        banner: '/images/tribuhne-circus-kids.jpg',
    },
    'modern-dance': {
        label: 'Modern Dance',
        icon: 'fas fa-music',
        banner: '/images/studio-billies-kids-dance-class.jpg',
    },
    'yoga-wellness': {
        label: 'Yoga & Wellness',
        icon: 'fas fa-spa',
        banner: '/images/nia-ulli-sievers.jpeg',
    },
    'coaching-leadership': {
        label: 'Coaching & Leadership',
        icon: 'fas fa-user-tie',
        banner: '/images/helge-hellberg-coach.jpg',
    },
    'festivals-events': {
        label: 'Festivals & Events',
        icon: 'fas fa-drum',
        banner: '/images/forro-immersion.png',
    },
    'folklore-swing': {
        label: 'Folklore & Swing',
        icon: 'fas fa-guitar',
        banner: '/images/swingwerkstatt.jpg',
    },
};

const categoryOrder = [
    'circus-kindertanz',
    'modern-dance',
    'yoga-wellness',
    'coaching-leadership',
    'festivals-events',
    'folklore-swing',
];

const grouped = categoryOrder
    .map((key) => ({
        key,
        meta: categoryMeta[key],
        courses: courses.filter((c) => c.data.category === key),
    }))
    .filter((g) => g.courses.length > 0);
---

<section class="studios bg-beige" id="courses">
    <div class="container">
        <h2 class="section-title text-raisin">Unsere Mieter</h2>

        {grouped.map((group) => (
            <div class="category-accordion">
                <button
                    class="category-banner"
                    aria-expanded="false"
                    data-category={group.key}
                >
                    <img
                        src={group.meta.banner}
                        alt={group.meta.label}
                        class="category-banner-img"
                        loading="lazy"
                    />
                    <div class="category-banner-overlay">
                        <i class={group.meta.icon}></i>
                        <span class="category-banner-label">{group.meta.label}</span>
                        <i class="fas fa-chevron-down category-chevron"></i>
                    </div>
                </button>

                <div class="category-panel">
                    <div class="studios-grid">
                        {group.courses.map((course) => {
                            const d = course.data;
                            const mainLink = d.website || d.instagram || (d.email ? `mailto:${d.email}` : '#');
                            return (
                                <div class="studio-card">
                                    <div class="studio-image-wrapper">
                                        <img src={d.image} alt={d.name} class="studio-image" loading="lazy" />
                                        <div class="studio-overlay">
                                            <div class="studio-icon">
                                                <i class={d.icon}></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="studio-content">
                                        <h3 class="studio-name">{d.name}</h3>
                                        <img src={d.logo} alt={`${d.name} Logo`} style="width: 100%; max-width: 200px; height: auto; margin: 10px 0;" loading="lazy" />
                                        <p class="studio-description">{d.description}</p>
                                        <p class="studio-features">{d.features}</p>
                                        {d.photoCredit && (
                                            <p style="font-size: 0.85em; color: #666; margin-top: 5px;">{d.photoCredit}</p>
                                        )}
                                        <div class="contact-info" style="font-size: 0.9em; color: #666; margin: 15px 0;">
                                            {d.website && (
                                                <p><i class="fas fa-globe"></i> <a href={d.website} target="_blank" style="color: #666;">{d.website.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '')}</a></p>
                                            )}
                                            {d.email && (
                                                <p><i class="fas fa-envelope"></i> <a href={`mailto:${d.email}`} style="color: #666;">{d.email}</a></p>
                                            )}
                                            {d.phone && (
                                                <p><i class="fas fa-phone"></i> <a href={`tel:${d.phone.replace(/\s/g, '')}`} style="color: #666;">{d.phone}</a></p>
                                            )}
                                            {d.instagram && (
                                                <p><i class="fab fa-instagram"></i> <a href={d.instagram} target="_blank" style="color: #666;">@{d.instagram.split('/').pop()}</a></p>
                                            )}
                                        </div>
                                        <a href={mainLink} target={mainLink.startsWith('mailto:') ? undefined : '_blank'} class="btn btn-outline-raisin">Mehr erfahren</a>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        ))}
    </div>
</section>
